# HAO ES åˆ†è¯å™¨
## ç®€ä»‹
ä¸€ä¸ªelasticsearch ä¸­æ–‡åˆ†è¯ æ’ä»¶ã€‚

QQäº¤æµç¾¤ï¼š743457803

> **å¦‚ä½•å¼€å‘ä¸€ä¸ªESåˆ†è¯æ’ä»¶**è¯·å‚è€ƒ [è¿™é‡Œ](https://github.com/tenlee2012/elasticsearch-analysis-demo)

ä¸»è¦å‚è€ƒäº† [IK](https://github.com/medcl/elasticsearch-analysis-ik) å’Œ [HanLP](https://github.com/hankcs/HanLP)


### ç‰¹æ€§

- æ”¯æŒ**å¤æ‚æ±‰å­—**ï¼Œæœ‰çš„æ±‰å­—åœ¨javaä¸­é•¿åº¦**ä¸æ˜¯1**ï¼Œæ¯”å¦‚`ğ¡ƒ`ï¼Œè€Œ`IK`ç­‰ä¸æ”¯æŒã€‚

- æ”¯æŒ**å•å­—**åˆ†è¯å’Œæœç´¢ï¼Œè€Œ`ik_max_word`æ¨¡å¼ä¸æ”¯æŒã€‚

- æ”¯æŒ**è‡ªå®šä¹‰é•¿åº¦åˆ†è¯**ï¼Œé€‚åˆçŸ­æ–‡æœ¬ä¸‹çš„äººåç­‰è¯†åˆ«ã€‚
> æ ¹æ®ç©ºæ ¼æ ‡ç‚¹ç¬¦å·å­—æ¯æ•°å­—ç­‰åˆ†éš”åçš„æ±‰å­—æ–‡æœ¬é•¿åº¦`<=autoWordLength`ä¼šè‡ªåŠ¨è¯†åˆ«ä¸ºä¸€ä¸ªè¯è¯­ã€‚
  
- æ”¯æŒemojiæœç´¢

- ç›¸æ¯”IKï¼Œæ¯”IKæ›´æ™ºèƒ½ï¼Œæ›´å‡†ç¡®ã€‚
  - ç¤ºä¾‹ï¼šæ¯”å¦‚IK `ik_max_word`æ˜¯ç©·ä¸¾æ‰€æœ‰å¯èƒ½è¯ï¼Œå¯¼è‡´æœç´¢ä¸€äº›ä¸ç›¸å…³çš„ä¹Ÿä¼šè¢«æœåˆ°ã€‚
`ä»»æ€§å†²åŠ¨è¿‡`åˆ†è¯ç»“æœå±…ç„¶æœ‰`ä»»æ€§ æ€§å†²åŠ¨ åŠ¨è¿‡`,é‚£ä¹ˆæœ`æ€§å†²åŠ¨`å°±ä¼šæŠŠè¿™ä¸ªdocæœç´¢åˆ°ã€‚
`å—äº¬å¸‚é•¿æ±Ÿå¤§æ¡¥`ï¼Œç»“æœæ˜¯`å—äº¬å¸‚ å¸‚é•¿ é•¿æ±Ÿå¤§æ¡¥`ï¼Œé‚£ä¹ˆæœ`å¸‚é•¿`ä¼šæŠŠè¿™ä¸ªdocæœç´¢åˆ°ï¼Œè€Œhaoåˆ†è¯å™¨ä¸ä¼šï¼Œé€šè¿‡è¯é¢‘è®¡ç®—æœ€çŸ­è·¯ï¼Œè¯†åˆ«å‡ºå¯èƒ½æ€§æœ€é«˜çš„è¯ç»„ã€‚è¿˜å¯ä»¥æ ¹æ®è‡ªå·±åœºæ™¯ï¼Œéšæ„è°ƒèŠ‚è¯é¢‘ã€‚

- [ik_smart åˆ†è¯ç»“æœä¸æ˜¯ ik_max_word çš„å­é›†](https://github.com/medcl/elasticsearch-analysis-ik/issues/584)ï¼Œhao_search_mode åˆ†è¯ç»“æœæ˜¯ hao_index_mode åˆ†è¯ç»“æœçš„å­é›†

- ç›¸æ¯”HanLpï¼Œæ¯”HanLPæ›´è½»é‡ï¼Œ**åˆ†è¯æ›´å¯æ§**ï¼Œæ²¡æœ‰ä¸€äº›æ™ºèƒ½çš„äººåç­‰é¢„æµ‹åŠŸèƒ½ï¼Œå¯èƒ½ä¼šå¯¼è‡´åˆ†è¯ä¸ç¨³å®šä¸å‡†ç¡®ï¼Œæœºå™¨å­¦ä¹ å¯¹äºé•¿çŸ­æ–‡æœ¬ä¸åŒï¼Œé¢„æµ‹åˆ†è¯ç»“æœä¹Ÿä¸åŒã€‚å¹¶ä¸”HanLPä¹Ÿæ²¡æœ‰å®˜æ–¹çš„ESæ’ä»¶ã€‚

- æ ¹æ®è¯é¢‘è®¡ç®—æœ€çŸ­è·¯ï¼Œç©·ä¸¾å‡ºå¯èƒ½çš„è¯ï¼Œè€Œä¸æ˜¯æ‰€æœ‰çš„è¯ï¼Œå¦‚æœç©·ä¸¾çš„è¯ä¸å¯¹ï¼Œå¯ä»¥è°ƒè¯é¢‘æ¥çº æ­£ï¼Œè¯é¢‘æ–‡ä»¶æ˜¯**å¯è¯»æ€§æ›´å¥½**çš„`txt`æ–‡ä»¶

- æ”¯æŒå…ƒè¯ï¼Œæ¯”å¦‚`ä¿„ç½—æ–¯`ä¸ä¼šå†æ‹†åˆ†æˆ`ä¿„`å’Œ`ç½—æ–¯`ï¼ˆ`ç½—æ–¯`æ˜¯å¸¸ç”¨äººåï¼‰ã€‚è¿™æ ·æœ`ç½—æ–¯`å°±ä¸ä¼šæŠŠ`ä¿„ç½—æ–¯`ç›¸å…³æ–‡æ¡£å¬å›

- ä½†æ˜¯ä¸æ”¯æŒè¯æ€§


æä¾›
Analyzer: `hao_search_mode`, `hao_index_mode`
Tokenizer: `hao_search_mode`, `hao_index_mode`

Versions
--------

Git tag | ES version
-----------|-----------
master | ESæœ€æ–°ç¨³å®šç‰ˆ
v7.17.1 | 7.17.1
vX.Y.Z | X.Y.Z

## ä½¿ç”¨
### å®‰è£…
æ–¹å¼1. `bin/elasticsearch-plugin install file:///Users/xiaoming/Download/analysis-hao.zip`

æ–¹å¼2. è§£å‹åï¼Œæ”¾åœ¨es pluginsç›®å½•å³å¯ï¼Œä¿è¯æ˜¯å¦‚ä¸‹ç›®å½•ç»“æ„ `{ES_HOME}/plugins/analysis-hao/(å„ç§jarç­‰æ–‡ä»¶)`ï¼ŒåŒæ—¶ç›®å½•ä¸èƒ½æœ‰zipæ–‡ä»¶

æœ€åé‡å¯ES

### ES ç‰ˆæœ¬å‡çº§
å¦‚æœæ²¡æœ‰ä½ éœ€è¦çš„å¯¹åº”ESç‰ˆæœ¬ï¼Œè¦ä¿®æ”¹ä¸€ä¸‹å‡ ä¸ªåœ°æ–¹ï¼š
1. ä¿®æ”¹`pom.xml`->`elasticsearch.version`çš„å€¼ä¸ºå¯¹åº”ç‰ˆæœ¬ã€‚
2. ç¼–è¯‘ï¼ŒæŒ‰ç…§å“åº”æŠ¥é”™ä¿®æ”¹ä»£ç ï¼Œæ¯”å¦‚å¯èƒ½æœ‰`HaoTokenizerFactory.java`çš„æ„é€ æ–¹æ³•ã€‚
   æœ€åæ‰§è¡Œ `mvn clean package -Dmaven.test.skip=true`ï¼Œå°±å¯ä»¥å¾—åˆ°æ’ä»¶çš„`zip`å®‰è£…åŒ…ã€‚

### åˆ†è¯å™¨
ä¸‹é¢æ˜¯è‡ªå®šä¹‰åˆ†è¯å™¨å¯ç”¨çš„é…ç½®é¡¹
#### å‚æ•°
---
é…ç½®é¡¹å‚æ•° | åŠŸèƒ½ | é»˜è®¤å€¼
----|---|---
`enableIndexMode` | æ˜¯å¦ä½¿ç”¨indexæ¨¡å¼ï¼Œindexæ¨¡å¼ä¸ºç»†é¢—ç²’åº¦ã€‚| `hao_search_mode`ä¸º`false`ï¼Œ`hao_index_mode`ä¸º`true`,ç»†é¢—ç²’åº¦é€‚åˆTerm Query,ç²—é¢—ç²’åº¦é€‚åˆPhraseæŸ¥è¯¢
`enableFallBack` | å¦‚æœåˆ†è¯æŠ¥é”™ï¼Œæ˜¯å¦å¯åŠ¨æœ€ç»†ç²’åº¦åˆ†è¯ï¼Œå³æŒ‰å­—åˆ†ã€‚å»ºè®®`search_mode`ä½¿ç”¨ï¼Œä¸è‡³äºå½±å“ç”¨æˆ·æœç´¢ã€‚`index_mode`ä¸å¯åŠ¨ï¼Œä»¥ä¾¿åŠæ—¶æŠ¥é”™å‘Šè­¦é€šçŸ¥ã€‚| `false`ä¸å¯åŠ¨é™çº§
`enableFailDingMsg` | æ˜¯å¦å¯åŠ¨å¤±è´¥é’‰é’‰é€šçŸ¥,é€šçŸ¥åœ°å€ä¸º`HttpAnalyzer.cfg.xml`çš„`dingWebHookUrl`å­—æ®µã€‚| `false`
`enableSingleWord` | æ˜¯å¦ä½¿ç”¨ç»†ç²’åº¦è¿”å›çš„å•å­—ã€‚æ¯”å¦‚`ä½“åŠ›å€¼`ï¼Œåˆ†è¯ç»“æœåªå­˜`ä½“åŠ›å€¼`,`ä½“åŠ›`,è€Œä¸å­˜`å€¼` | `false`
`autoWordLength` | æ ¹æ®ç©ºæ ¼æ ‡ç‚¹ç¬¦å·å­—æ¯æ•°å­—ç­‰åˆ†éš”åçš„æ±‰å­—æ–‡æœ¬é•¿åº¦å°äº`autoWordLength`ä¼šè‡ªåŠ¨è¯†åˆ«ä¸ºä¸€ä¸ªè¯è¯­ã€‚ é»˜è®¤-1ä¸å¼€å¯ï¼Œ**>=2**è§†ä¸ºå¼€å¯| `-1`

#### å†…ç½®åˆ†è¯å™¨ä»‹ç»
- `hao_index_mode`

ä¼šæ ¹æ®è¯åº“çš„è¯æ¡å’Œæƒé‡ï¼Œé€’å½’åˆ†è¯ï¼Œç›´åˆ°è¯¥è¯ä¸å¯åˆ†ã€‚å¦‚æœè®¾ç½®äº†`enableSingleWord=true`ï¼Œä¼šä¸€ç›´åˆ†åˆ°å•å­—ä¸ºæ­¢ã€‚

ä¾‹å¦‚è¿™æ®µæ–‡æœ¬`å—äº¬å¸‚é•¿æ±Ÿå¤§æ¡¥`
1. `å—äº¬å¸‚é•¿æ±Ÿå¤§æ¡¥` ==> `å—äº¬å¸‚`, `é•¿æ±Ÿå¤§æ¡¥`
2. `å—äº¬å¸‚`==>`å—äº¬`,`å¸‚`, `é•¿æ±Ÿå¤§æ¡¥`==>`é•¿æ±Ÿ`,`å¤§æ¡¥`
3. å¦‚æœ`enableSingleWord=false`ï¼Œé€’å½’åœæ­¢ï¼Œå¾—åˆ°åˆ†è¯ä¸º`å—äº¬å¸‚`,`å—äº¬`,`å¸‚`,`é•¿æ±Ÿå¤§æ¡¥`,`é•¿æ±Ÿ`,`å¤§æ¡¥`
4. å¦‚æœ`enableSingleWord=true`ï¼Œç»§ç»­é€’å½’ï¼Œç›´åˆ°å•å­—ä½ç½®ï¼Œå¾—åˆ°åˆ†è¯ä¸º`å—äº¬å¸‚`,`å—äº¬`,`å—`,`äº¬`,`å¸‚`,`é•¿æ±Ÿå¤§æ¡¥`,`é•¿æ±Ÿ`,`é•¿`,`æ±Ÿ`,`å¤§æ¡¥`,`å¤§`,`æ¡¥`
- `hao_search_mode`

è¯¥æ¨¡å¼ä¸‹ï¼Œç›¸å½“äº`hao_index_mode`æ¨¡å¼åªé€’å½’ä¸€æ¬¡ã€‚
åˆ†è¯ç»“æœä¸º`å—äº¬å¸‚`, `é•¿æ±Ÿå¤§æ¡¥`ã€‚å› ä¸ºè¯¥æ¨¡å¼ä¸‹`enableIndexMode=false`ï¼Œå¦‚æœæ”¹æˆ`true`ï¼Œåˆ™å’Œ`hao_index_mode`ä¸€æ ·çš„æ•ˆæœã€‚
### HaoAnalyzer.cfg.xml é…ç½®

---
å‚æ•°| åŠŸèƒ½ | å¤‡æ³¨
--- | --- | ---
`baseDictionary` |åŸºç¡€è¯åº“æ–‡ä»¶å | æ”¾åœ¨æ’ä»¶`config`ç›®å½•æˆ–è€…esçš„`config`ç›®å½•ï¼Œä¸ç”¨æ›´æ”¹
`customerDictionaryFile` | ç”¨æˆ·è‡ªå®šä¹‰è¿œç¨‹è¯åº“æ–‡ä»¶ï¼Œå¤šä¸ªæ–‡ä»¶ç”¨è‹±æ–‡åˆ†å·;åˆ†éš”| ä¼šå­˜å‚¨åœ¨æ’ä»¶`config`ç›®å½•æˆ–è€…esçš„`config`ç›®å½•
`remoteFreqDict` | è¿œç¨‹ç”¨æˆ·è‡ªå®šä¹‰è¯åº“æ–‡ä»¶ | æ–¹ä¾¿çƒ­æ›´æ–°ï¼Œçƒ­æ›´æ–°é€šè¿‡ä¸‹é¢ä¸¤ä¸ªå‚æ•°å®šæ—¶æ›´æ–°ã€‚
`syncDicTime` | è¿œç¨‹è¯åº“ä¸‹æ¬¡åŒæ­¥æ—¶é—´ `hh:mm:ss` | ä¸å¡«ä½¿ç”¨`syncDicPeriodTime`ä½œä¸ºä¸‹æ¬¡åŒæ­¥æ—¶é—´
`syncDicPeriodTime` | è¿œç¨‹è¯åº“åŒæ­¥æ—¶é—´é—´éš”,ç§’,æœ€å°å€¼30 | æ¯”å¦‚ `syncDicTime=20:00:00,syncDicPeriodTime=86400`ï¼Œåˆ™æ˜¯æ¯å¤©20ç‚¹åŒæ­¥
`dingWebHookUrl` | é’‰é’‰æœºå™¨äººurl | ç”¨äºåˆ†è¯å¼‚å¸¸ï¼ŒåŒæ­¥è¯åº“å¼‚å¸¸/æˆåŠŸé€šçŸ¥|
`dingMsgContent` | æœºå™¨äººé€šçŸ¥æ–‡æ¡ˆ | æ³¨æ„é…ç½®é’‰é’‰æœºå™¨äººçš„æ—¶å€™å…³é”®è¯è¦å’Œè¿™ä¸ªæ–‡æ¡ˆåŒ¹é…ï¼Œä¸ç„¶ä¼šæ¶ˆæ¯å‘é€å¤±è´¥

### è¯åº“è¯´æ˜
> ä¼˜å…ˆè¯»å– `{ES_HOME}/config/analysis-hao/`ç›®å½•ï¼Œæ²¡æœ‰è¯»å– `{ES_HOME}/plugins/analysis-hao/config`ç›®å½•ä¸‹çš„æ–‡ä»¶

- åŸºç¡€è¯åº“
  åŸºç¡€è¯åº“æ˜¯`base_dictionary.txt`ï¼Œä»¥é€—å·åˆ†å‰²ï¼Œåé¢çš„æ•°å­—è¡¨ç¤ºè¯é¢‘ã€‚
  ä¾‹å¦‚ï¼š`å¥‹å‘å›¾å¼º` åˆ†è¯ç»“æœæ˜¯ `å¥‹`, `å‘å›¾`, `å¼º`, æ˜¯å› ä¸º`å‘å›¾`è¿™ä¸ªè¯çš„è¯é¢‘å¤ªé«˜äº†ï¼ˆå› ä¸ºå‡ºç°æ¬¡æ•°é«˜ï¼‰ï¼Œåˆ™å¯ä»¥é™ä½è¯é¢‘ï¼Œæ‰‹åŠ¨ä¿®æ”¹`base_dictionary.txt`æ–‡ä»¶å°±å¥½äº†ã€‚
- è¿œç¨‹è¯åº“
  ç”¨æˆ·è‡ªå®šä¹‰è¯åº“ä¼šæŒ‰ç…§é…ç½®çš„æ—¶é—´å’Œå‘¨æœŸå®šæœŸæ‰§è¡Œã€‚
  ä»è¿œç¨‹è¯åº“æ›´æ–°å®Œæˆåä¼šè‡ªåŠ¨è¦†ç›–ç°åœ¨çš„`customerDictionaryFile`ã€‚
  è¿œç¨‹è¯åº“çš„æ–‡ä»¶æ ¼å¼**æ¯è¡Œ**æ ¼å¼ä¸º `{è¯},{è¯é¢‘},{æ˜¯å¦å…ƒè¯}`, ä¾‹å¦‚`ä¿„ç½—æ–¯,1000,1`ã€‚
  æ˜¯å¦å…ƒè¯å­—æ®µè§£é‡Šï¼š
  `1`ä»£è¡¨æ˜¯å…ƒè¯ï¼Œä¸ä¼šå†ç»†æ‹†åˆ†ï¼Œ`ä¿„ç½—æ–¯`ä¸ä¼šå†æ‹†åˆ†æˆ`ä¿„`å’Œ`ç½—æ–¯`ï¼ˆç½—æ–¯æ˜¯å¸¸ç”¨äººåï¼‰ã€‚è¿™æ ·æœ`ç½—æ–¯`å°±ä¸ä¼šæŠŠ`ä¿„ç½—æ–¯`ç›¸å…³æ–‡æ¡£å¬å›ã€‚
  `0`å°±æ˜¯å¯ä»¥ç»§ç»­ç»†æ‹†åˆ†ï¼Œæ¯”å¦‚`å¥‹å‘å›¾å¼º`
- è¿œç¨‹è¯åº“æ˜¯å¦é‡æ–°åŠ è½½æ˜¯æ ¹æ® http head è¯·æ±‚è¿”å›å¤´ä¸­çš„ä¸¤ä¸ªå­—æ®µæ˜¯å¦æœ‰è‡³å°‘æœ‰ä¸€ä¸ªå‘ç”Ÿå˜åŒ–ï¼Œä¸¤ä¸ªå­—æ®µä¸ºï¼šLast-Modifiedã€ETag


### ç¤ºä¾‹ç´¢å¼•demo
å»ºç´¢å¼•ï¼š
```
PUT test/
{
  "settings": {
    "index": {
      "analysis": {
        "analyzer": {
          "search_analyzer": {
            "filter": [
              "lowercase"
            ],
            "char_filter": [
              "html_strip"
            ],
            "type": "custom",
            "tokenizer": "my_search_token"
          },
          "index_analyzer": {
            "filter": [
              "lowercase"
            ],
            "char_filter": [
              "html_strip"
            ],
            "type": "custom",
            "tokenizer": "my_index_token"
          }
        },
        "tokenizer": {
          "my_index_token": {
            "enableFailDingMsg": "true",
            "type": "hao_index_mode",
            "enableSingleWord": "true",
            "enableFallBack": "true",
            "autoWordLength": 3
          },
          "my_search_token": {
            "enableFailDingMsg": "true",
            "type": "hao_search_mode",
            "enableSingleWord": "true",
            "enableFallBack": "true",
            "autoWordLength": 3
          }
        }
      },
      "number_of_replicas": "0"
    }
  },
  "mappings": {
    "properties": {
      "title": {
        "type": "text",
        "index_options": "offsets",
        "analyzer": "index_analyzer",
        "search_analyzer": "search_analyzer"
      }
    }
  }
}
```
æµ‹è¯•åˆ†è¯
```
test/_analyze
{
  "analyzer": "index_analyzer",
  "text": "å¾åº†å¹´ å¥‹å‘å›¾å¼ºæ‰“ç¯®çƒæœ‰åˆ©äºæé«˜äººæ°‘ç”Ÿæ´»ï¼Œæœ‰çš„æ”¾çŸ¢ï¼Œä¸­åäººæ°‘å…±å’Œå›½å®¶åº­å®£ä¼ å§”å‘˜ä¼šå®£ã€‚ğŸ¶"
}

test/_analyze
{
  "analyzer": "search_analyzer",
  "text": "å¾åº†å¹´ å¥‹å‘å›¾å¼ºæ‰“ç¯®çƒæœ‰åˆ©äºæé«˜äººæ°‘ç”Ÿæ´»ï¼Œæœ‰çš„æ”¾çŸ¢ï¼Œä¸­åäººæ°‘å…±å’Œå›½å®¶åº­å®£ä¼ å§”å‘˜ä¼šå®£ã€‚ğŸ¶"
}
```
`å¾åº†å¹´`å¹¶ä¸åœ¨è¯åº“ä¸­ï¼Œä½†æ˜¯é€šè¿‡`autoWordLength`è¯†åˆ«ä¸ºä¸€ä¸ªè¯ã€‚

